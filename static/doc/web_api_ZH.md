## ğŸ“Œ 1. æ·»åŠ ç”¨æˆ· Token

* **æ¥å£åœ°å€**ï¼š`POST /user/token/add`
* **åŠŸèƒ½è¯´æ˜**ï¼šæ·»åŠ ç”¨æˆ·å¯ç”¨çš„ Token æ•°é‡ã€‚
* **è¯·æ±‚å‚æ•°**ï¼ˆJSON Bodyï¼‰ï¼š

```json
{
  "user_id": "string",
  "token": 100
}
```

| å‚æ•°å     | ç±»å‹     | å¿…å¡« | è¯´æ˜            |
|---------|--------|----|---------------|
| user_id | string | æ˜¯  | ç”¨æˆ·å”¯ä¸€æ ‡è¯†        |
| token   | int    | æ˜¯  | è¦å¢åŠ çš„ Token æ•°é‡ |

* **å“åº”ç¤ºä¾‹**ï¼š

```json
{
  "code": 0,
  "msg": "success",
  "data": null
}
```

---

## ğŸ“Œ 2. è·å–ç”¨æˆ·åˆ—è¡¨

* **æ¥å£åœ°å€**ï¼š`GET /user/list`
* **åŠŸèƒ½è¯´æ˜**ï¼šåˆ†é¡µè·å–ç”¨æˆ·ä¿¡æ¯åˆ—è¡¨ï¼Œå¯æ ¹æ® `user_id` è¿‡æ»¤ã€‚
* **è¯·æ±‚å‚æ•°**ï¼ˆQueryï¼‰ï¼š

| å‚æ•°å       | ç±»å‹     | å¿…å¡« | è¯´æ˜          |
|-----------|--------|----|-------------|
| page      | int    | å¦  | é¡µç ï¼ˆé»˜è®¤ 1ï¼‰    |
| page_size | int    | å¦  | æ¯é¡µæ•°é‡ï¼ˆé»˜è®¤ 10ï¼‰ |
| user_id   | string | å¦  | æ ¹æ®ç”¨æˆ·IDè¿‡æ»¤    |

* **å“åº”ç¤ºä¾‹**ï¼š

```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "list": [
      {
        "id": 1,
        "user_id": "user123",
        "mode": "default",
        "token": 100,
        "updatetime": 1623456789,
        "avail_token": 50
      }
    ],
    "total": 1
  }
}
```

---

## ğŸ“Œ 3. æ›´æ–°ç”¨æˆ·æ¨¡å¼

* **æ¥å£åœ°å€**ï¼š`POST /user/update/mode`
* **åŠŸèƒ½è¯´æ˜**ï¼šä¿®æ”¹ç”¨æˆ·çš„æ¨¡å‹ï¼ˆmodeï¼‰ã€‚
* **è¯·æ±‚å‚æ•°**ï¼ˆForm è¡¨å•ï¼‰ï¼š

| å‚æ•°å     | ç±»å‹     | å¿…å¡« | è¯´æ˜      |
|---------|--------|----|---------|
| user_id | string | æ˜¯  | ç”¨æˆ·å”¯ä¸€æ ‡è¯†  |
| mode    | string | æ˜¯  | è¦è®¾ç½®çš„æ–°æ¨¡å¼ |

* **å“åº”ç¤ºä¾‹**ï¼š

```json
{
  "code": 0,
  "msg": "success",
  "data": null
}
```

---

## ğŸ“Œ 4. è·å–ç”¨æˆ·è®°å½•

* **æ¥å£åœ°å€**ï¼š`GET /record/list`
* **åŠŸèƒ½è¯´æ˜**ï¼šåˆ†é¡µè·å–ç”¨æˆ·å¯¹è¯è®°å½•ï¼Œå¯æ ¹æ®æ˜¯å¦åˆ é™¤åŠç”¨æˆ· ID è¿‡æ»¤ã€‚
* **è¯·æ±‚å‚æ•°**ï¼ˆQueryï¼‰ï¼š

| å‚æ•°å       | ç±»å‹     | å¿…å¡« | è¯´æ˜                   |
|-----------|--------|----|----------------------|
| page      | int    | å¦  | é¡µç ï¼ˆé»˜è®¤ 1ï¼‰             |
| pageSize  | int    | å¦  | æ¯é¡µæ•°é‡ï¼ˆé»˜è®¤ 10ï¼‰          |
| isDeleted | int    | å¦  | æ˜¯å¦åˆ é™¤ï¼ˆ0ï¼šæœªåˆ ï¼Œ1ï¼šå·²åˆ ï¼Œé»˜è®¤å…¨éƒ¨ï¼‰ |
| user_id   | string | å¦  | ç”¨æˆ· ID                |

* **å“åº”ç¤ºä¾‹**ï¼š

```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "list": [
      {
        "id": 1,
        "user_id": "user123",
        "question": "What's AI?",
        "answer": "Artificial Intelligence...",
        "content": "conversation content",
        "token": 50,
        "is_deleted": 0,
        "create_time": 1623456789,
        "record_type": 1
      }
    ],
    "total": 1
  }
}
```

---

## ğŸ“„ æ•°æ®ç»“æ„è¯´æ˜

### âœ… User å¯¹è±¡å­—æ®µè¯´æ˜

| å­—æ®µå         | ç±»å‹     | è¯´æ˜          |
|-------------|--------|-------------|
| id          | int64  | ç”¨æˆ·ä¸»é”® ID     |
| user_id     | string | ç”¨æˆ·å”¯ä¸€æ ‡è¯†      |
| mode        | string | å½“å‰æ¨¡å¼        |
| token       | int    | æ€» Token     |
| updatetime  | int64  | æ›´æ–°æ—¶é—´ï¼ˆæ—¶é—´æˆ³ï¼‰   |
| avail_token | int    | å¯ç”¨ Token æ•°é‡ |

---

### âœ… Record å¯¹è±¡å­—æ®µè¯´æ˜

| å­—æ®µå         | ç±»å‹     | è¯´æ˜                 |
|-------------|--------|--------------------|
| id          | int    | è®°å½• ID              |
| user_id     | string | æ‰€å±ç”¨æˆ· ID            |
| question    | string | ç”¨æˆ·æé—®å†…å®¹             |
| answer      | string | ç³»ç»Ÿå›ç­”               |
| content     | string | ç”¨æˆ·ä¸Šä¼ çš„ç‰¹æ®Šæ•°æ®ï¼Œå¦‚ å›¾ç‰‡ è¯­éŸ³ç­‰ |
| token       | int    | æ¶ˆè€—çš„ token æ•°é‡       |
| is_deleted  | int    | æ˜¯å¦åˆ é™¤ï¼ˆ0=å¦ï¼Œ1=æ˜¯ï¼‰      |
| create_time | int64  | åˆ›å»ºæ—¶é—´ï¼ˆæ—¶é—´æˆ³ï¼‰          |
| record_type | int    | è®°å½•ç±»å‹ï¼ˆå¦‚ WEBã€å…¶ä»–ç±»å‹ï¼‰   |

---

## 5. å®æ—¶é€šä¿¡æ¥å£ â€” `Communicate`

* **æ¥å£åœ°å€**ï¼š`POST /communicate`
* **åŠŸèƒ½è¯´æ˜**ï¼šé€šè¿‡ Server-Sent Events (SSE) å®æ—¶å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ï¼Œæ”¯æŒæ–‡æœ¬å¯¹è¯ã€å›¾ç‰‡/è§†é¢‘ç”ŸæˆåŠå¤šä»£ç†ä»»åŠ¡ç­‰åŠŸèƒ½ï¼Œæ”¯æŒå¤šç§å‘½ä»¤ã€‚

---

### è¯·æ±‚è¯´æ˜

* **è¯·æ±‚æ–¹æ³•**ï¼š`POST`
* **è¯·æ±‚å¤´**ï¼š

    * `Content-Type`: ä¾æ®è¯·æ±‚ä½“å†…å®¹ï¼Œé€šå¸¸ä¸º `application/octet-stream`ï¼ˆå›¾ç‰‡æˆ–è§†é¢‘äºŒè¿›åˆ¶æ•°æ®ï¼‰
* **è¯·æ±‚å‚æ•°ï¼ˆQueryï¼‰**ï¼š

| å‚æ•°å     | ç±»å‹     | å¿…å¡« | è¯´æ˜                        |
|---------|--------|----|---------------------------|
| prompt  | string | æ˜¯  | è¯·æ±‚å†…å®¹ï¼Œå¯åŒ…å«å‘½ä»¤ï¼ˆä»¥ `/` å¼€å¤´ï¼‰æˆ–æ™®é€šæ–‡æœ¬ |
| user_id | string | æ˜¯  | ç”¨æˆ·å”¯ä¸€æ ‡è¯†ï¼ˆæ•°å­—å­—ç¬¦ä¸²ï¼‰             |

* **è¯·æ±‚ä½“**ï¼š

    * ä¼ å…¥äºŒè¿›åˆ¶æ•°æ®ï¼Œå¦‚å›¾ç‰‡æˆ–éŸ³é¢‘æ•°æ®ï¼ˆæ ¹æ®å‘½ä»¤å†³å®šæ˜¯å¦éœ€è¦ï¼‰ã€‚

---

### å‘½ä»¤è¯´æ˜

æ¥å£æ”¯æŒçš„å‘½ä»¤å¦‚ä¸‹ï¼ˆå‡ä»¥ `/` å¼€å¤´ï¼‰ï¼š

| å‘½ä»¤         | åŠŸèƒ½è¯´æ˜              |
|------------|-------------------|
| `/chat`    | å¼€å¯æ™®é€šèŠå¤©ä¼šè¯          |
| `/mode`    | è®¾ç½® LLM æ¨¡å¼         |
| `/balance` | æŸ¥è¯¢å½“å‰ä½™é¢ï¼ˆtoken æˆ–ç§¯åˆ†ï¼‰ |
| `/state`   | æŸ¥çœ‹å½“å‰ä¼šè¯çŠ¶æ€å’Œè®¾ç½®       |
| `/clear`   | æ¸…é™¤æ‰€æœ‰å¯¹è¯å†å²          |
| `/retry`   | é‡è¯•ä¸Šä¸€æ¬¡æé—®           |
| `/photo`   | æ ¹æ®æç¤ºæˆ–ä¸Šä¼ å›¾ç‰‡ç”Ÿæˆå›¾åƒ     |
| `/video`   | æ ¹æ®æç¤ºç”Ÿæˆè§†é¢‘          |
| `/task`    | è®©å¤šä¸ªä»£ç†åä½œå®Œæˆä»»åŠ¡       |
| `/mcp`     | ä½¿ç”¨å¤šä»£ç†æ§åˆ¶é¢æ¿è¿›è¡Œå¤æ‚ä»»åŠ¡è§„åˆ’ |
| `/help`    | æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯ï¼ˆæœ¬å‘½ä»¤åˆ—è¡¨ï¼‰     |

---

### å“åº”è¯´æ˜

* **å“åº”ç±»å‹**ï¼š`text/event-stream`

* **å“åº”å¤´**ï¼š

    * `Content-Type: text/event-stream`
    * `Cache-Control: no-cache`
    * `Connection: keep-alive`

* **å“åº”ä½“**ï¼š

    * å®æ—¶æ¨é€çš„äº‹ä»¶æµæ•°æ®ï¼Œæ ¼å¼ç”±åç«¯ä¸šåŠ¡é€»è¾‘å®šä¹‰ã€‚

* **é”™è¯¯å“åº”**ï¼š

| çŠ¶æ€ç  | è¯´æ˜              | å“åº”ç¤ºä¾‹æ–‡æœ¬                                              |
|-----|-----------------|-----------------------------------------------------|
| 400 | ç¼ºå°‘å¿…è¦å‚æ•° `prompt` | Missing prompt parameter                            |
| 500 | è¯·æ±‚ä½“è¯»å–å¤±è´¥æˆ–ä¸æ”¯æŒæµ    | Error reading request body æˆ– Streaming unsupported! |

---

### ç¤ºä¾‹è¯·æ±‚

```http
POST /api/communicate?prompt=/photo sunset&user_id=12345 HTTP/1.1
Content-Type: application/octet-stream

<äºŒè¿›åˆ¶å›¾ç‰‡æ•°æ®>
```

---
## 6. è·å–å½“å‰å¯åŠ¨å‚æ•°å‘½ä»¤è¡Œä¿¡æ¯

* **æ¥å£åœ°å€**ï¼š`GET /command/get`
* **åŠŸèƒ½è¯´æ˜**ï¼šè¿”å›å½“å‰æœåŠ¡å„é…ç½®ç»“æ„ä½“å­—æ®µä¸å¯åŠ¨å‚æ•° flag ä¸ä¸€è‡´çš„éƒ¨åˆ†ï¼Œä»¥å‘½ä»¤è¡Œå‚æ•°æ ¼å¼æ‹¼æ¥ï¼Œä¾¿äºè°ƒè¯•æˆ–é…ç½®æ£€æŸ¥ã€‚
* **è¯·æ±‚å‚æ•°**ï¼šæ— 
* **å“åº”ç¤ºä¾‹**ï¼š

```json
{
  "code": 0,
  "msg": "success",
  "data": "-mcp_conf_path=/path/to/mcp_conf.json -some_flag=value "
}
```

---

## 2. è·å–å®Œæ•´å½“å‰é…ç½®

* **æ¥å£åœ°å€**ï¼š`GET /conf/get`
* **åŠŸèƒ½è¯´æ˜**ï¼šè¿”å›æ‰€æœ‰é…ç½®æ¨¡å—å½“å‰çš„å®Œæ•´é…ç½®ä¿¡æ¯ï¼ŒåŒ…æ‹¬ baseã€audioã€llmã€photoã€ragã€videoã€‚
* **è¯·æ±‚å‚æ•°**ï¼šæ— 
* **å“åº”ç¤ºä¾‹**ï¼š

```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "base": { ... },
    "audio": { ... },
    "llm": { ... },
    "photo": { ... },
    "rag": { ... },
    "video": { ... }
  }
}
```

---

## 3. æ›´æ–°é…ç½®å­—æ®µ

* **æ¥å£åœ°å€**ï¼š`POST /conf/update`
* **åŠŸèƒ½è¯´æ˜**ï¼šåŠ¨æ€æ›´æ–°æŒ‡å®šç±»å‹é…ç½®ç»“æ„ä½“çš„æŒ‡å®šå­—æ®µå€¼ã€‚
* **è¯·æ±‚å‚æ•°**ï¼ˆJSON Bodyï¼‰ï¼š

```json
{
  "type": "base|audio|llm|photo|rag|video",
  "key": "json_tagå­—æ®µå",
  "value": "æ›´æ–°åçš„å€¼"
}
```

| å‚æ•°å   | ç±»å‹     | å¿…å¡« | è¯´æ˜              |
| ----- | ------ | -- | --------------- |
| type  | string | æ˜¯  | é…ç½®ç±»å‹ï¼Œå¦‚ `"base"` |
| key   | string | æ˜¯  | ç»“æ„ä½“å­—æ®µçš„ json tag |
| value | any    | æ˜¯  | éœ€è¦æ›´æ–°çš„å€¼          |

* **å“åº”ç¤ºä¾‹**ï¼š

```json
{
  "code": 0,
  "msg": "success",
  "data": ""
}
```

* **æ³¨æ„**ï¼š

    * å¯¹äºç‰¹æ®Šå­—æ®µï¼ˆå¦‚ `allowed_telegram_user_ids`ã€`admin_user_ids` ç­‰ï¼‰ä¼šåšç‰¹æ®Šæ ¼å¼è½¬æ¢ã€‚
    * ä¸æ”¯æŒçš„ç±»å‹ä¼šè¿”å›å‚æ•°é”™è¯¯ã€‚

---

## 4. è·å– MCP é…ç½®

* **æ¥å£åœ°å€**ï¼š`GET /mcp/get`
* **åŠŸèƒ½è¯´æ˜**ï¼šè¯»å–å¹¶è¿”å› MCP é…ç½®æ–‡ä»¶çš„å†…å®¹ã€‚
* **è¯·æ±‚å‚æ•°**ï¼šæ— 
* **å“åº”ç¤ºä¾‹**ï¼š

```json
{
  "code": 0,
  "msg": "success",
  "data": {
    "McpServers": {
      "server1": { ... },
      "server2": { ... }
    },
    ...
  }
}
```

---

## 5. æ›´æ–° MCP é…ç½®

* **æ¥å£åœ°å€**ï¼š`POST /mcp/update?name={name}`
* **åŠŸèƒ½è¯´æ˜**ï¼šæ›´æ–° MCP é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šæœåŠ¡å™¨åç§°çš„é…ç½®ã€‚
* **è¯·æ±‚å‚æ•°**ï¼š

    * Queryå‚æ•°ï¼š

        * `name` (string, å¿…å¡«)ï¼šMCPæœåŠ¡å™¨åç§°
    * JSON Bodyï¼šMCP é…ç½®å¯¹è±¡ï¼Œç»“æ„ä½“ `mcpParam.MCPConfig`
* **å“åº”ç¤ºä¾‹**ï¼š

```json
{
  "code": 0,
  "msg": "success",
  "data": ""
}
```

---

## 6. åˆ é™¤ MCP é…ç½®

* **æ¥å£åœ°å€**ï¼š`DELETE /mcp/delete?name={name}`
* **åŠŸèƒ½è¯´æ˜**ï¼šåˆ é™¤ MCP é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šæœåŠ¡å™¨åç§°çš„é…ç½®ï¼ŒåŒæ—¶å…³é—­å¯¹åº”å®¢æˆ·ç«¯å¹¶ä»ä»»åŠ¡å·¥å…·ä¸­åˆ é™¤ã€‚
* **è¯·æ±‚å‚æ•°**ï¼š

    * Queryå‚æ•°ï¼š

        * `name` (string, å¿…å¡«)ï¼šMCPæœåŠ¡å™¨åç§°
* **å“åº”ç¤ºä¾‹**ï¼š

```json
{
  "code": 0,
  "msg": "success",
  "data": ""
}
```

---

## 7. å¯ç”¨æˆ–ç¦ç”¨ MCP é…ç½®

* **æ¥å£åœ°å€**ï¼š`POST /mcp/disable?name={name}&disable={0|1}`
* **åŠŸèƒ½è¯´æ˜**ï¼šå¯ç”¨æˆ–ç¦ç”¨æŒ‡å®šåç§°çš„ MCP é…ç½®ã€‚
* **è¯·æ±‚å‚æ•°**ï¼š

    * Queryå‚æ•°ï¼š

        * `name` (string, å¿…å¡«)ï¼šMCPæœåŠ¡å™¨åç§°
        * `disable` (string, å¿…å¡«)ï¼š`1` è¡¨ç¤ºç¦ç”¨ï¼Œ`0` è¡¨ç¤ºå¯ç”¨
* **å“åº”ç¤ºä¾‹**ï¼š

```json
{
  "code": 0,
  "msg": "success",
  "data": ""
}
```

---

## 8. åŒæ­¥ MCP é…ç½®

* **æ¥å£åœ°å€**ï¼š`POST /mcp/sync`
* **åŠŸèƒ½è¯´æ˜**ï¼šæ¸…é™¤æ‰€æœ‰ MCP å®¢æˆ·ç«¯åŠä»»åŠ¡å·¥å…·ï¼Œé‡æ–°åˆå§‹åŒ–ã€‚
* **è¯·æ±‚å‚æ•°**ï¼šæ— 
* **å“åº”ç¤ºä¾‹**ï¼š

```json
{
  "code": 0,
  "msg": "success",
  "data": ""
}
```

---

# å¤‡æ³¨

* æ‰€æœ‰æˆåŠŸå“åº”æ ¼å¼ï¼š

```json
{
  "code": 0,
  "msg": "success",
  "data": ""
}
```

* å¤±è´¥å“åº”æ ¼å¼ç±»ä¼¼ï¼Œä½† `code` å’Œ `msg` ä¼šä½“ç°å…·ä½“é”™è¯¯ï¼Œé€šå¸¸ä¸ºï¼š

```json
{
  "code": <é”™è¯¯ç >,
  "msg": <é”™è¯¯ä¿¡æ¯>,
  "data": null
}
```




